<%- include ('./partials/secureHeader') %>	

        <!-- Page Content - Only Page Elements Here-->
        <div class="page-content footer-clear">

            <!-- Page Title-->
            <div class="pt-3">
                <div class="page-title d-flex">
                    <div class="align-self-center">
                        <a href="#"
                            data-back-button
                            class="me-3 ms-0 icon icon-xxs bg-theme rounded-s shadow-m">
                            <i class="bi bi-chevron-left color-theme font-14"></i>

                        </a>
                    </div>
                    <div class="align-self-center me-auto">
                        <h1 class="color-theme mb-0 font-18">Verify Account</h1>
                    </div>
                    <div class="align-self-center ms-auto">
                        <a href="#" data-bs-toggle="offcanvas" data-bs-target="#menu-sidebar"
                            class="icon icon-xxs gradient-highlight color-white shadow-bg shadow-bg-xs rounded-s">
                            <i class="bi bi-list font-20"></i>
                        </a>
                    </div>
                </div>
            </div>




            <link rel="stylesheet" href="/card/style.css">
            <script src="/card/costom.js"></script>



            <div class="card card-style">
                <div class="content">

                    <div class="text-center">
                        <img src="/img/XXL_height.webp" class="img-fluid rounded-s">
                    </div>
                    <h4>User Verification</h4>
                    <h5>Upload your ID card</h5>
                    <p style="margin-bottom: 20px !important;" class="mb-0">
                        (Driving License or Government ID card)<br>
                        Uploading your ID helps as ensure the safety and security of your funds
                    </p>





                                            <form id="kyc_form">

                            <div class="form-custom form-label form-icon mb-3">
                                <i class="bi bi-file-earmark-binary font-13"></i>

                                <!-- <select name="doc_typ" class="form-select rounded-xs" id="c6" aria-label="Floating label select example">
                                    <option class="opt" selected value="">Select Document</option>
                                    <option class="opt" value="Int Passport">Int Passport</option>
                                    <option class="opt" value="Driving License">Driving License</option>
                                    <option class="opt" value="Identity Card">Govt Approved Identity Card</option>
                                </select> -->

                                <select name="doc_typ" class="form-select rounded-xs" id="c6" aria-label="Floating label select example">
                                    <option class="opt" value="">Select Document</option>
                                    <option class="opt" value="Int Passport" >Int Passport</option>
                                    <option class="opt" value="Driving License" >Driving License</option>
                                    <option class="opt" value="Identity Card" >Govt Approved Identity Card</option>
                                </select>





                                <label for="c6" class="color-highlight form-label-always-active">Select Document Type</label>
                            </div>

                            <div class="row">



                                <div class="file-data">
                                    <div class="form-custom form-label mb-3 form-icon">
                                        <!-- Dropify File Input -->
                                        <input required type="file" name="kyc_file_front" class="dropify" data-height="50" data-default-file="images/" />
                                        <label for="c6" class="color-highlight form-label-always-active">Document Front</label>
                                    </div>
                                </div>


                                <div class="file-data">
                                    <div class="form-custom form-label mb-3 form-icon">
                                        <!-- Dropify File Input -->
                                        <!-- <label>Phone Number</label> -->
                                        <input required type="file" name="kyc_file_back" class="dropify" data-height="50" data-default-file="images/" />
                                        <label for="c6" class="color-highlight form-label-always-active">Document Back</label>
                                    </div>
                                </div>




                            </div>
                            <div class="divider mt-2 mb-4"></div>

                            <a href="#" id="kycbtn" class="btn btn-full gradient-highlight shadow-bg shadow-bg-s">Upload</a>

                        </form>


                </div>

            </div>

        </div>
     

        <!-- Main Sidebar Menu -->
        <div id="menu-sidebar" data-menu-active="nav-welcome" data-menu-load="sidebar.html"
            class="offcanvas offcanvas-start offcanvas-detached rounded-m">
        </div>

        <!-- Highlights Menu -->
        <div id="menu-highlights" data-menu-load="menu-highlights.html"
            class="offcanvas offcanvas-bottom offcanvas-detached rounded-m">
        </div>

        <!-- Notifications Bell -->
        <div id="menu-notifications" data-menu-load="menu-notifications.html"
            class="offcanvas offcanvas-top offcanvas-detached rounded-m">
        </div>

        <!-- modal section -->
        <div id="deposit_modal" data-menu-load="deposit_modal.php"
            class="offcanvas offcanvas-bottom offcanvas-detached rounded-m">
        </div>
        <!-- modalsection ends  -->

        <!--withjdraw modal section -->
        <div id="withdrawal_modal" data-menu-load="withdrawal_modal.php"
            class="offcanvas offcanvas-bottom offcanvas-detached rounded-m">
        </div>
        <!-- withdraw modalsection ends  -->



    </div>
    <!-- End of Page ID-->

    <script src="/scripts/bootstrap.min.js"></script>
    <script src="/scripts/custom.js"></script>
</body>


<script>
    //////when deposit button is clicked
    $(document).on("click", "#kycbtn", function(e) {
        e.preventDefault();

        // Change the button text and add a spinner
        $(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing, please wait...')
            .css("pointer-events", "none"); // Prevent multiple clicks

        // Get form data properly
        var formData = new FormData(document.getElementById("kyc_form"));
        formData.append("kyc_sub", "kyc_sub");



        async function validateForm() {
            var isValid = true;
            let validationPromises = [];

            $("#kyc_form input, #kyc_form select, #kyc_form textarea").each(function() {
                let formContainer = $(this).closest(".form-custom.form-label.mb-3.form-icon");

                if ($(this).attr("type") === "file") {
                    let fileInput = $(this);
                    let dropifyInstance = fileInput.data('dropify');

                    let validationPromise = new Promise((resolve) => {
                        setTimeout(async function() {
                            let previewImg = fileInput.closest('.dropify-wrapper')
                                .find('.dropify-preview .dropify-render img');

                            if (previewImg.length > 0) {
                                let imgSrc = previewImg.attr('src');

                                // console.log('Dropify Preview Image Source:', imgSrc);

                                if (imgSrc && imgSrc.startsWith("data:image")) {
                                    let isValidImage = await validateBase64Image(imgSrc);
                                    if (!isValidImage) {
                                        markInvalid(fileInput, formContainer, dropifyInstance);
                                        resolve(false);
                                    } else {
                                        formContainer.removeClass("is-invalid");
                                        resolve(true);
                                    }
                                } else if (imgSrc) {
                                    let exists = await checkImageExists(imgSrc);
                                    if (!exists) {
                                        markInvalid(fileInput, formContainer, dropifyInstance);
                                        resolve(false);
                                    } else {
                                        formContainer.removeClass("is-invalid");
                                        resolve(true);
                                    }
                                } else {
                                    markInvalid(fileInput, formContainer, dropifyInstance);
                                    resolve(false);
                                }
                            } else {
                                markInvalid(fileInput, formContainer, dropifyInstance);
                                resolve(false);
                            }
                        }, 500);
                    });

                    validationPromises.push(validationPromise);
                } else {
                    if (!$(this).val()) {
                        formContainer.addClass("is-invalid");
                        isValid = false;
                    } else {
                        formContainer.removeClass("is-invalid");
                    }

                    $(this).on("input change", function() {
                        if ($(this).val()) {
                            formContainer.removeClass("is-invalid");
                        }
                    });
                }
            });

            let results = await Promise.all(validationPromises);
            if (results.includes(false)) {
                isValid = false;
            }

            if (!isValid) {
                iziToast.warning({
                    position: 'topRight',
                    title: 'Error',
                    message: `Form is invalid. Please fill in all required fields.!`,
                });
                $('#kycbtn').html('Upload').css("pointer-events", "auto");
            } else {
                console.log("✅ All fields are valid. Proceeding to next action...");
                ajaxcall();
            }
        }

        // Convert callback-based functions to promises
        function validateBase64Image(base64Str) {
            return new Promise((resolve) => {
                let img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                img.src = base64Str;
            });
        }

        function checkImageExists(url) {
            return new Promise((resolve) => {
                let img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                img.src = url;
            });
        }

        // Function to mark an input as invalid
        function markInvalid(fileInput, formContainer, dropifyInstance) {
            formContainer.addClass("is-invalid");
            if (dropifyInstance) {
                dropifyInstance.resetPreview();
                dropifyInstance.clearElement();
            }
        }

        // Trigger validation
        validateForm();

        function ajaxcall() {
            // Get form data properly
            var formData = new FormData(document.getElementById("kyc_form"));
            formData.append("kyc_sub", "kyc_sub");

            $.ajax({
                url: 'includes/server',
                type: 'POST',
                data: formData,
                contentType: false,
                cache: false,
                dataType: 'json', // Expect JSON response
                processData: false,
                success: function(response) {
                    if (response.mssg == "ok") {
                        iziToast.success({
                            position: 'topRight',
                            title: 'Profile Updated',
                            message: `Your update has been successfully applied!`,
                        });
                        $('#kycbtn').html('Upload').css("pointer-events", "auto");
                    } else {
                        iziToast.error({
                            position: 'topRight',
                            title: 'Error',
                            message: `${response.mssg}`,
                        });
                        $('#kycbtn').html('Upload').css("pointer-events", "auto");
                    }
                },
                error: function(xhr) {
                    console.error('Error:', xhr.responseText);
                }
            });
        }
    });
</script>